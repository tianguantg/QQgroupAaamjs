<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‰«ğŸ·</title>
    <style>
        :root {
            --bg-color: #fce4ec;
            --board-bg: #8d6e63;
            --cell-closed: #a1887f;
            --cell-open: #efebe9;
            --highlight: #f8bbd0;
            --text-color: #4e342e;
            --shadow-light: rgba(255, 255, 255, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --cell-size: 30px; /* åŠ¨æ€å˜é‡ */
            --cols: 9; /* åŠ¨æ€å˜é‡ */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
                height: 100vh;
    height: 100dvh; 
            width: 100vw;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
        }

        /* --- é¡¶éƒ¨ä¿¡æ¯æ  --- */
        header {
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
            height: 60px;
        }

        .status-box { text-align: center; font-weight: bold; min-width: 60px; }
        .status-label { font-size: 10px; color: #888; margin-bottom: 2px; }
        .status-value { font-size: 20px; font-family: monospace; }
        
        .emoji-btn {
            font-size: 26px;
            cursor: pointer;
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 50%;
            background: #f5f5f5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .emoji-btn:active { transform: scale(0.9); background: #eee; }

        /* --- æ¸¸æˆä¸»åŒºåŸŸ (è‡ªé€‚åº”æ ¸å¿ƒ) --- */
        #game-container {
            flex: 1; /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
            display: flex;
            justify-content: center;
            align-items: center; /* å‚ç›´å±…ä¸­ */
            padding: 10px;
            overflow: hidden; /* ç¦æ­¢å†…éƒ¨æ»šåŠ¨ */
            position: relative;
        }

        #grid {
            display: grid;
            /* æ ¸å¿ƒï¼šä½¿ç”¨ CSS å˜é‡å®šä¹‰åˆ—æ•°å’Œå¤§å° */
            grid-template-columns: repeat(var(--cols), var(--cell-size));
            gap: 2px;
            background-color: var(--board-bg);
            padding: 4px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s; /* ç®€å•çš„ç¼©æ”¾åŠ¨ç”» */
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: var(--cell-closed);
            border-radius: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            /* å­—ä½“å¤§å°éšæ ¼å­å¤§å°å˜åŒ– */
            font-size: calc(var(--cell-size) * 0.6); 
            cursor: pointer;
            box-shadow: inset 2px 2px 0 var(--shadow-light), inset -2px -2px 0 var(--shadow-dark);
        }

        .cell.open {
            background-color: var(--cell-open);
            box-shadow: none;
            border: 1px solid #d7ccc8;
        }
        
        /* æ ‡è®° */
        .cell.flagged { font-size: calc(var(--cell-size) * 0.5); }

        /* æ•°å­—é¢œè‰² */
        .c1 { color: #1976D2; } .c2 { color: #388E3C; } .c3 { color: #D32F2F; }
        .c4 { color: #7B1FA2; } .c5 { color: #FF8F00; } .c6 { color: #0097A7; }
        .c7 { color: #424242; } .c8 { color: #8D6E63; }

        /* --- åº•éƒ¨æ§åˆ¶æ  --- */
        footer {
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            padding: 10px 15px;
            background: #fff;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* é€‚é… iPhone åº•éƒ¨æ¡ */
        }

        .mode-btn {
            padding: 6px 12px;
            border: 1px solid var(--board-bg);
            border-radius: 15px;
            background: transparent;
            color: var(--board-bg);
            font-weight: bold;
            font-size: 13px;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }

        .mode-btn.active {
            background: var(--board-bg);
            color: #fff;
            box-shadow: 0 2px 6px rgba(141, 110, 99, 0.4);
        }

        /* --- å¼¹çª—ä¸æç¤º --- */
        #overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }

        #overlay.visible { opacity: 1; pointer-events: auto; }

        .modal {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            width: 75%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        #overlay.visible .modal { transform: scale(1); }

        .restart-btn {
            background: var(--board-bg);
            color: white; border: none; padding: 10px 24px;
            border-radius: 20px; font-size: 16px; font-weight: bold;
            margin-top: 15px;
        }
        
        .toast {
            position: fixed;
            top: 70px; /* ç§»åˆ°é¡¶éƒ¨ï¼Œé˜²æ­¢æŒ¡ä½åº•éƒ¨æ ¼å­ */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 50;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <div class="status-box">
            <div class="status-label">çŒªçŒª</div>
            <div class="status-value" id="mine-count">000</div>
        </div>
        <div class="emoji-btn" id="face-btn">ğŸ˜Š</div>
        <div class="status-box">
            <div class="status-label">è€—æ—¶</div>
            <div class="status-value" id="timer">000</div>
        </div>
    </header>

    <div id="game-container">
        <div id="grid"></div>
    </div>

    <div class="toast" id="toast">é•¿æŒ‰æ–¹å—æ’æ—— ğŸš©</div>

    <footer>
        <button class="mode-btn" onclick="setDifficulty('easy')">ç®€å•</button>
        <button class="mode-btn" onclick="setDifficulty('medium')">ä¸­ç­‰</button>
        <button class="mode-btn" onclick="setDifficulty('hard')">å›°éš¾</button>
    </footer>

    <div id="overlay">
        <div class="modal">
            <h2 id="modal-title" style="margin:0 0 10px 0;">ç»“æŸ</h2>
            <p id="modal-msg" style="color:#666; margin:0;">...</p>
            <button class="restart-btn" onclick="resetGame()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const CONFIG = {
            easy: { rows: 9, cols: 9, mines: 10 },
            medium: { rows: 12, cols: 12, mines: 20 },
            hard: { rows: 20, cols: 12, mines: 35 } // ç«–å±ä¸“å®¶æ¨¡å¼
        };

        // çŠ¶æ€å˜é‡
        let currentDiff = 'easy';
        let gridData = [];
        let gameActive = false;
        let flags = 0;
        let time = 0;
        let timerInterval;
        let isFirstClick = true;
        let longPressTimer;

        // DOM å…ƒç´ 
        const gridEl = document.getElementById('grid');
        const containerEl = document.getElementById('game-container');
        const mineCountEl = document.getElementById('mine-count');
        const timerEl = document.getElementById('timer');
        const faceBtn = document.getElementById('face-btn');
        const overlay = document.getElementById('overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');

        // åˆå§‹åŒ–
        function init() {
            // é˜»æ­¢æµè§ˆå™¨é»˜è®¤èœå•
            window.oncontextmenu = (e) => {
                e.preventDefault();
                return false;
            };
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œå®æ—¶è°ƒæ•´ç½‘æ ¼
            window.addEventListener('resize', calculateGridSize);
            
            setDifficulty('easy');
            showToast();
        }

        // åˆ‡æ¢éš¾åº¦
        function setDifficulty(diff) {
            currentDiff = diff;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.onclick.toString().includes(diff)) btn.classList.add('active');
            });
            resetGame();
        }

        // æ ¸å¿ƒï¼šè®¡ç®—ç½‘æ ¼å°ºå¯¸
        function calculateGridSize() {
            if (!containerEl) return;
            
            const { rows, cols } = CONFIG[currentDiff];
            
            // è·å–å®¹å™¨å®é™…å¯ç”¨ç©ºé—´ï¼ˆå‡å»paddingï¼‰
            const availableWidth = containerEl.clientWidth - 20;
            const availableHeight = containerEl.clientHeight - 20;

            // è®¡ç®—ä¸¤ç§æƒ…å†µä¸‹çš„å•å…ƒæ ¼å¤§å°
            const sizeByWidth = Math.floor(availableWidth / cols);
            const sizeByHeight = Math.floor(availableHeight / rows);

            // å–è¾ƒå°å€¼ï¼Œç¡®ä¿å®Œå…¨æ”¾å…¥å®¹å™¨
            // é™åˆ¶æœ€å¤§ä¸º 45pxï¼Œé˜²æ­¢åœ¨ç”µè„‘å¤§å±ä¸Šè¿‡äºå·¨å¤§
            const finalSize = Math.min(sizeByWidth, sizeByHeight, 45);

            // æ›´æ–° CSS å˜é‡
            document.documentElement.style.setProperty('--cell-size', `${finalSize}px`);
            document.documentElement.style.setProperty('--cols', cols);
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            clearInterval(timerInterval);
            time = 0;
            timerEl.innerText = '000';
            gameActive = true;
            isFirstClick = true;
            faceBtn.innerText = 'ğŸ˜Š';
            overlay.classList.remove('visible');
            
            const { rows, cols, mines } = CONFIG[currentDiff];
            flags = mines;
            updateMineCount();

            // å…ˆè®¡ç®—å°ºå¯¸
            calculateGridSize();

            gridEl.innerHTML = '';
            gridData = [];

            // ç”Ÿæˆæ ¼å­
            for (let r = 0; r < rows; r++) {
                const row = [];
                for (let c = 0; c < cols; c++) {
                    const cellData = {
                        r, c,
                        isMine: false, isOpen: false, isFlagged: false,
                        element: null, neighbors: 0
                    };
                    
                    const el = document.createElement('div');
                    el.className = 'cell';
                    
                    bindEvents(el, r, c);
                    
                    cellData.element = el;
                    row.push(cellData);
                    gridEl.appendChild(el);
                }
                gridData.push(row);
            }
        }

        // ç»‘å®šäº‹ä»¶ï¼ˆè§¦æ‘¸ä¸ç‚¹å‡»ï¼‰
        function bindEvents(el, r, c) {
            const handleStart = (e) => {
                if (!gameActive || gridData[r][c].isOpen) return;
                longPressTimer = setTimeout(() => {
                    toggleFlag(r, c);
                    longPressTimer = null;
                    if (navigator.vibrate) navigator.vibrate(50);
                }, 350); // ç•¥å¾®ç¼©çŸ­é•¿æŒ‰åˆ¤æ–­æ—¶é—´
            };

            const handleEnd = (e) => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                    handleClick(r, c); // éé•¿æŒ‰å³ä¸ºç‚¹å‡»
                }
                // å¦‚æœä¸æ˜¯å³é”®ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸ºé˜²æ­¢ç¼©æ”¾
                if(e.type !== 'mouseup' || e.button !== 2) {
                     // e.preventDefault(); 
                     // æ³¨æ„ï¼šè¿™é‡Œå®Œå…¨é˜»æ­¢ preventDefault å¯èƒ½ä¼šå½±å“éƒ¨åˆ†æœºå‹çš„ç‚¹å‡»ï¼Œ
                     // ä½†æˆ‘ä»¬å·²ç»åœ¨ CSS è®¾ç½®äº† touch-action æˆ– user-scalableï¼Œé€šå¸¸åªéœ€å¤„ç†é€»è¾‘
                }
            };

            el.addEventListener('touchstart', handleStart, {passive: true});
            el.addEventListener('touchend', (e) => {
                e.preventDefault(); // é˜»æ­¢è§¦æ‘¸åçš„æ¨¡æ‹Ÿé¼ æ ‡ç‚¹å‡»
                handleEnd(e);
            }, {passive: false});

            el.addEventListener('mousedown', (e) => {
                if(e.button === 0) handleStart(e);
                if(e.button === 2) toggleFlag(r, c);
            });
            el.addEventListener('mouseup', (e) => {
                if(e.button === 0) handleEnd(e);
            });
            el.addEventListener('touchmove', () => {
                if(longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
            });
        }

        // ç‚¹å‡»é€»è¾‘
        function handleClick(r, c) {
            const cell = gridData[r][c];
            if (cell.isFlagged || cell.isOpen || !gameActive) return;

            if (isFirstClick) {
                placeMines(r, c);
                startTimer();
                isFirstClick = false;
            }
            openCell(r, c);
        }

        // æ’æ——é€»è¾‘
        function toggleFlag(r, c) {
            const cell = gridData[r][c];
            if (cell.isOpen || !gameActive) return;

            cell.isFlagged = !cell.isFlagged;
            cell.element.classList.toggle('flagged');
            cell.element.innerText = cell.isFlagged ? 'ğŸš©' : '';
            
            flags += cell.isFlagged ? -1 : 1;
            updateMineCount();
        }

        // å¸ƒé›·é€»è¾‘ (ä¿è¯é¦–ç‚¹å®‰å…¨)
        function placeMines(safeR, safeC) {
            const { rows, cols, mines } = CONFIG[currentDiff];
            let placed = 0;
            while (placed < mines) {
                const r = Math.floor(Math.random() * rows);
                const c = Math.floor(Math.random() * cols);
                // æ’é™¤é¦–ç‚¹ä¹å®«æ ¼
                if (!gridData[r][c].isMine && (Math.abs(r - safeR) > 1 || Math.abs(c - safeC) > 1)) {
                    gridData[r][c].isMine = true;
                    placed++;
                }
            }
            // è®¡ç®—æ•°å­—
            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    if(!gridData[r][c].isMine) gridData[r][c].neighbors = countNeighbors(r, c);
                }
            }
        }

        function countNeighbors(r, c) {
            let count = 0;
            const { rows, cols } = CONFIG[currentDiff];
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const nr = r + i, nc = c + j;
                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && gridData[nr][nc].isMine) count++;
                }
            }
            return count;
        }

        // é€’å½’æ‰“å¼€
        function openCell(r, c) {
            const cell = gridData[r][c];
            if (cell.isOpen || cell.isFlagged) return;

            cell.isOpen = true;
            cell.element.classList.add('open');

            if (cell.isMine) {
                gameOver(false);
                cell.element.innerText = 'ğŸ·';
                cell.element.style.backgroundColor = '#ef9a9a';
                return;
            }

            if (cell.neighbors > 0) {
                cell.element.innerText = cell.neighbors;
                cell.element.classList.add(`c${cell.neighbors}`);
            } else {
                const { rows, cols } = CONFIG[currentDiff];
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        const nr = r + i, nc = c + j;
                        if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) openCell(nr, nc);
                    }
                }
            }
            checkWin();
        }

        function checkWin() {
            const { rows, cols, mines } = CONFIG[currentDiff];
            const opened = gridData.flat().filter(c => c.isOpen).length;
            if (opened === rows * cols - mines) gameOver(true);
        }

        function gameOver(win) {
            gameActive = false;
            clearInterval(timerInterval);
            faceBtn.innerText = win ? 'ğŸ˜' : 'ğŸ˜µ';
            
            if (!win) {
                gridData.flat().forEach(cell => {
                    if (cell.isMine) {
                        cell.element.innerText = 'ğŸ·';
                        if (!cell.isOpen) cell.element.style.color = '#555';
                    } else if (cell.isFlagged) {
                        cell.element.innerText = 'âŒ'; // æ ‡è®°é”™è¯¯
                        cell.element.style.color = 'red';
                    }
                });
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            } else {
                flags = 0;
                updateMineCount();
            }

            setTimeout(() => {
                modalTitle.innerText = win ? "å¤§è·å…¨èƒœï¼ğŸ‰" : "è¢«çŒªçŒªå‘ç°äº†ï¼";
                modalMsg.innerText = win ? `è€—æ—¶: ${time} ç§’` : "å†æ¥å†å‰";
                overlay.classList.add('visible');
            }, 600);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                time++;
                timerEl.innerText = time.toString().padStart(3, '0');
            }, 1000);
        }

        function updateMineCount() {
            mineCountEl.innerText = flags.toString().padStart(3, '0');
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        faceBtn.onclick = resetGame;

        init();

    </script>
</body>
</html>
